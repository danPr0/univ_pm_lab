{% extends "base.html" %}
{% block title %}Movie Catalog{% endblock %}

{% block navbar %}
<nav class="navbar">
    <ul>
        <li><a href="{{ url_for('index') }}" class="active">Catalog</a></li>
        {% if user %}
        <li><a href="{{ url_for('recommendations') }}">Recommendations</a></li>
        {% endif %}
    </ul>
</nav>
{% endblock %}

{% block content %}
    <h1>üé¨ Movie Catalog</h1>

    {% if user %}
        <p class="user-info">Welcome, {{ user.full_name }} | <a href="{{ url_for('logout') }}">Logout</a></p>
    {% else %}
        <p class="user-info">
            <a href="{{ url_for('login') }}">Sign In</a> or <a href="{{ url_for('signup') }}">Sign Up</a> to save your
            favorites.
        </p>
    {% endif %}

    {% if movies %}
        <table class="movie-table">
            <thead>
            <tr>
{#                <th>ID</th>#}
                <th>Name</th>
                <th>Year</th>
                <th>Director</th>
                <th>Studio</th>
                <th>Duration (min)</th>
                <th>Rating</th>
                <th>Description</th>
                {% if user %}
                <th style="width: 60px; text-align: center;">Like</th>
                {% endif %}
            </tr>
            </thead>
            <tbody>
            {% for movie in movies %}
                <tr>
{#                    <td>{{ movie.id }}</td>#}
                    <td>{{ movie.name }}</td>
                    <td>{{ movie.date.year if movie.date else '' }}</td>
                    <td>{{ movie.director or '-' }}</td>
                    <td>{{ movie.studio or '-' }}</td>
                    <td>{{ movie.duration or '-' }}</td>
                    <td>{{ movie.rating or '-' }}</td>
{#                    <td>{{ movie.description[:120] ~ ('...' if movie.description|length > 120 else '') }}</td>#}
                    <td class="movie-table__description-cell">{{ movie.description }}</td>
                    {% if user %}
                    <td style="text-align: center;">
                        <button class="like-btn {% if movie.id in watchlist_movie_ids %}liked{% endif %}"
                                data-movie-id="{{ movie.id }}"
                                onclick="toggleWatchlist({{ movie.id }}, this)">
                            <span class="heart">‚ù§</span>
                        </button>
                    </td>
                    {% endif %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="empty-state">The films are not yet in the database.</p>
    {% endif %}

    <script>
        function toggleWatchlist(movieId, button) {
            fetch(`/toggle_watchlist/${movieId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    // Toggle the liked class
                    if (data.in_watchlist) {
                        button.classList.add('liked');
                    } else {
                        button.classList.remove('liked');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
    </script>
{% endblock %}